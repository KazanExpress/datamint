{"version":3,"file":"weborm.iife.js","sources":["../src/entry.ts","../src/drivers/NoDriver.ts","../src/drivers/LocalStorageDriver.ts","../src/drivers/index.ts","../src/index.ts"],"sourcesContent":["import { WebORMDriver } from './';\n\nexport default class Entry {\n  constructor(\n    private driver: WebORMDriver,\n    private path: string,\n    public value,\n    private fetchHandler: () => (Promise<any> | void) = () => {}\n  ) { }\n\n  public sync() {\n    return new Promise(async (resolve, reject) => {\n      let data = await this.fetchHandler();\n      await this.driver.add(this.path, data);\n      resolve(data);\n    });\n  }\n}\n","import { WebORMDriver } from '../';\nimport Entry from '../entry';\n\nexport class NoDriver implements WebORMDriver {\n  public isSuitable() {\n    return true;\n  }\n\n  public setName(name: string) { }\n\n  public async get(key: string, fetchHandler?: () => (Promise<any> | void)) {\n    return new Entry(this, key, null);\n  }\n\n  public async add(key: string, entry: any, fetchHandler?: () => (Promise<any> | void)) {\n    return false;\n  }\n}\n","import { fromPath } from './';\nimport { WebORMDriver } from '../';\nimport Entry from '../entry';\n\nexport class LocalStorageDriver implements WebORMDriver {\n  private name: string = '';\n\n  public isSuitable() {\n    return typeof localStorage !== 'undefined';\n  }\n\n  public setName(name: string) {\n    this.name = name;\n  }\n\n  public async get(key: string, fetchHandler?: () => (Promise<any> | void)) {\n    let result = undefined;\n    let obj = this.getRootFromPath(key);\n\n    if (obj) {\n      let path = key.split('/').slice(1).join('/');\n      result = fromPath(obj, path, '/');\n    }\n\n    return new Entry(this, key, result, fetchHandler);\n  }\n\n  public async add(key: string, entry: any, fetchHandler?: () => (Promise<any> | void)) {\n    let obj = this.getRootFromPath(key);\n    obj = typeof obj === 'object' ? Object(obj) : {};\n\n    let pathArr = key.split('/');\n    let path = pathArr.slice(1).join('/');\n\n    obj = this.setDeepVal(obj, path, entry);\n    localStorage.setItem(`${this.name}_${pathArr[0]}`, JSON.stringify(obj));\n\n    return true;\n  }\n\n  private setDeepVal(obj, path: string, val) {\n    if (!path) {\n      if (typeof val === 'object') {\n        return { ...obj, ...val };\n      }\n\n      return obj;\n    }\n\n    let props = path.split('/');\n    let workingObj = obj;\n    for (var i = 0, n = props.length - 1; i < n; ++i) {\n      workingObj = workingObj[props[i]] = workingObj[props[i]] || {};\n    }\n    workingObj[props[i]] = val;\n\n    return obj;\n  }\n\n  private getRootFromPath(path: string) {\n    let rootPath = path.split('/')[0];\n\n    if (rootPath) {\n      let stringObj = localStorage.getItem(`${this.name}_${rootPath}`);\n\n      if (stringObj) {\n        return JSON.parse(stringObj);\n      }\n    }\n  }\n}\n","export * from './LocalStorageDriver';\nexport * from './NoDriver';\n\nexport function fromPath(obj, path: string, sep: string = '.') {\n  return path.split(sep).reduce((o, i) => (o === Object(o) ? o[i] : o), obj);\n}\n","import { NoDriver } from './drivers/NoDriver';\nimport Entry from './entry';\n\nexport * from './drivers';\n\nconst LOG_PREFIX = '[WebORM] ';\n\nexport default class WebORM {\n  public driver: WebORMDriver;\n  private APIMap: IAPIMap;\n\n  constructor(\n    public name: string,\n    options: IWebORMOptions = {}\n  ) {\n    this.APIMap = options.APIMap || {};\n    this.driver = new NoDriver();\n\n    if (options.drivers) {\n      options.drivers.forEach(driver => {\n        if ((this.driver instanceof NoDriver) && driver.isSuitable()) {\n          this.driver = driver;\n        }\n      });\n    }\n\n    if (this.driver instanceof NoDriver) {\n      console.warn(`${LOG_PREFIX} Warning! You have no suitable driver for database. Using memory instead.`);\n    }\n\n    this.driver.setName(name);\n    this.initPressetData(options.preset);\n  }\n\n  private initPressetData(data: any = {}) {\n    Object.keys(data).forEach(async presetKey => {\n      await this.driver.add(presetKey, data[presetKey]);\n    });\n  }\n\n  public async getEntry(key: string) {\n    let mapForPath = this.APIMap[key];\n    if (mapForPath && mapForPath.get) {\n      return this.driver.get(key, mapForPath.get);\n    }\n\n    return this.driver.get(key);\n  }\n\n  public async addEntry(key: string, entry: any) {\n    return this.driver.add(key, entry);\n  }\n}\n\nexport interface IWebORMOptions {\n  drivers?: WebORMDriver[];\n  preset?: { [key: string]: any };\n  APIMap?: IAPIMap;\n}\n\nexport interface IAPIMap {\n  [key: string]: {\n    get?: () => Promise<any>;\n    add?: () => (Promise<any> | void);\n  };\n}\n\nexport abstract class WebORMDriver {\n\n  /**\n   * Checks if driver can operate in current environment\n   *\n   * @returns is driver suitable\n   */\n  public isSuitable(): boolean { return false; }\n\n  public setName(name: string) { }\n\n  public async get(key: string, fetchHandler?: () => (Promise<any> | void)): Promise<Entry> {\n    return new Entry(this, key, null, fetchHandler);\n  }\n\n  public async add(key: string, entry: any, fetchHandler?: () => (Promise<any> | void)): Promise<boolean> {\n    return false;\n  }\n}\n"],"names":["LocalStorageDriver"],"mappings":"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"}