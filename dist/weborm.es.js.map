{"version":3,"file":"weborm.es.js","sources":["../src/entry.ts","../src/drivers/NoDriver.ts","../src/drivers/LocalStorageDriver.ts","../src/drivers/index.ts","../src/index.ts"],"sourcesContent":["import { WebORMDriver } from './';\n\nexport default class Entry {\n  constructor(\n    private driver: WebORMDriver,\n    private path: string,\n    public value,\n    private fetchHandler: () => (Promise<any> | void) = () => {}\n  ) { }\n\n  public sync() {\n    return new Promise(async (resolve, reject) => {\n      let data = await this.fetchHandler();\n      await this.driver.add(this.path, data);\n      resolve(data);\n    });\n  }\n}\n","import { WebORMDriver } from '../';\nimport Entry from '../entry';\n\nexport class NoDriver implements WebORMDriver {\n  public isSuitable() {\n    return true;\n  }\n\n  public setName(name: string) { }\n\n  public async get(key: string, fetchHandler?: () => (Promise<any> | void)) {\n    return new Entry(this, key, null);\n  }\n\n  public async add(key: string, entry: any, fetchHandler?: () => (Promise<any> | void)) {\n    return false;\n  }\n}\n","import { fromPath } from './';\nimport { WebORMDriver } from '../';\nimport Entry from '../entry';\n\nexport class LocalStorageDriver implements WebORMDriver {\n  private name: string = '';\n\n  public isSuitable() {\n    return typeof localStorage !== 'undefined';\n  }\n\n  public setName(name: string) {\n    this.name = name;\n  }\n\n  public async get(key: string, fetchHandler?: () => (Promise<any> | void)) {\n    let result = undefined;\n    let obj = this.getRootFromPath(key);\n\n    if (obj) {\n      let path = key.split('/').slice(1).join('/');\n      result = fromPath(obj, path, '/');\n    }\n\n    return new Entry(this, key, result, fetchHandler);\n  }\n\n  public async add(key: string, entry: any, fetchHandler?: () => (Promise<any> | void)) {\n    let obj = this.getRootFromPath(key);\n    obj = typeof obj === 'object' ? Object(obj) : {};\n\n    let pathArr = key.split('/');\n    let path = pathArr.slice(1).join('/');\n\n    obj = this.setDeepVal(obj, path, entry);\n    localStorage.setItem(`${this.name}_${pathArr[0]}`, JSON.stringify(obj));\n\n    return true;\n  }\n\n  private setDeepVal(obj, path: string, val) {\n    if (!path) {\n      if (typeof val === 'object') {\n        return { ...obj, ...val };\n      }\n\n      return obj;\n    }\n\n    let props = path.split('/');\n    let workingObj = obj;\n    for (var i = 0, n = props.length - 1; i < n; ++i) {\n      workingObj = workingObj[props[i]] = workingObj[props[i]] || {};\n    }\n    workingObj[props[i]] = val;\n\n    return obj;\n  }\n\n  private getRootFromPath(path: string) {\n    let rootPath = path.split('/')[0];\n\n    if (rootPath) {\n      let stringObj = localStorage.getItem(`${this.name}_${rootPath}`);\n\n      if (stringObj) {\n        return JSON.parse(stringObj);\n      }\n    }\n  }\n}\n","export * from './LocalStorageDriver';\nexport * from './NoDriver';\n\nexport function fromPath(obj, path: string, sep: string = '.') {\n  return path.split(sep).reduce((o, i) => (o === Object(o) ? o[i] : o), obj);\n}\n","import { NoDriver } from './drivers/NoDriver';\nimport Entry from './entry';\n\nexport * from './drivers';\n\nconst LOG_PREFIX = '[WebORM] ';\n\nexport default class WebORM {\n  public driver: WebORMDriver;\n  private APIMap: IAPIMap;\n\n  constructor(\n    public name: string,\n    options: IWebORMOptions = {}\n  ) {\n    this.APIMap = options.APIMap || {};\n    this.driver = new NoDriver();\n\n    if (options.drivers) {\n      options.drivers.forEach(driver => {\n        if ((this.driver instanceof NoDriver) && driver.isSuitable()) {\n          this.driver = driver;\n        }\n      });\n    }\n\n    if (this.driver instanceof NoDriver) {\n      console.warn(`${LOG_PREFIX} Warning! You have no suitable driver for database. Using memory instead.`);\n    }\n\n    this.driver.setName(name);\n    this.initPressetData(options.preset);\n  }\n\n  private initPressetData(data: any = {}) {\n    Object.keys(data).forEach(async presetKey => {\n      await this.driver.add(presetKey, data[presetKey]);\n    });\n  }\n\n  public async getEntry(key: string) {\n    let mapForPath = this.APIMap[key];\n    if (mapForPath && mapForPath.get) {\n      return this.driver.get(key, mapForPath.get);\n    }\n\n    return this.driver.get(key);\n  }\n\n  public async addEntry(key: string, entry: any) {\n    return this.driver.add(key, entry);\n  }\n}\n\nexport interface IWebORMOptions {\n  drivers?: WebORMDriver[];\n  preset?: { [key: string]: any };\n  APIMap?: IAPIMap;\n}\n\nexport interface IAPIMap {\n  [key: string]: {\n    get?: () => Promise<any>;\n    add?: () => (Promise<any> | void);\n  };\n}\n\nexport abstract class WebORMDriver {\n\n  /**\n   * Checks if driver can operate in current environment\n   *\n   * @returns is driver suitable\n   */\n  public isSuitable(): boolean { return false; }\n\n  public setName(name: string) { }\n\n  public async get(key: string, fetchHandler?: () => (Promise<any> | void)): Promise<Entry> {\n    return new Entry(this, key, null, fetchHandler);\n  }\n\n  public async add(key: string, entry: any, fetchHandler?: () => (Promise<any> | void)): Promise<boolean> {\n    return false;\n  }\n}\n"],"names":["LocalStorageDriver"],"mappings":"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"}