{"version":3,"file":"weborm.cjs.js","sources":["../src/entry.ts","../src/drivers/NoDriver.ts","../src/drivers/LocalStorageDriver.ts","../src/drivers/index.ts","../src/index.ts"],"sourcesContent":["import { WebORMDriver } from './';\n\nexport default class Entry {\n  constructor(\n    private driver: WebORMDriver,\n    private path: string,\n    public value,\n    private fetchHandler: () => (Promise<any> | void) = () => {}\n  ) { }\n\n  public sync() {\n    return new Promise(async (resolve, reject) => {\n      let data = await this.fetchHandler();\n      await this.driver.add(this.path, data);\n      resolve(data);\n    });\n  }\n}\n","import { WebORMDriver } from '../';\nimport Entry from '../entry';\n\nexport class NoDriver implements WebORMDriver {\n  public isSuitable() {\n    return true;\n  }\n\n  public setName(name: string) { }\n\n  public async get(key: string, fetchHandler?: () => (Promise<any> | void)) {\n    return new Entry(this, key, null);\n  }\n\n  public async add(key: string, entry: any, fetchHandler?: () => (Promise<any> | void)) {\n    return false;\n  }\n}\n","import { fromPath } from './';\nimport { WebORMDriver } from '../';\nimport Entry from '../entry';\n\nexport class LocalStorageDriver implements WebORMDriver {\n  private name: string = '';\n\n  public isSuitable() {\n    return typeof localStorage !== 'undefined';\n  }\n\n  public setName(name: string) {\n    this.name = name;\n  }\n\n  public async get(key: string, fetchHandler?: () => (Promise<any> | void)) {\n    let result = undefined;\n    let obj = this.getRootFromPath(key);\n\n    if (obj) {\n      let path = key.split('/').slice(1).join('/');\n      result = fromPath(obj, path, '/');\n    }\n\n    return new Entry(this, key, result, fetchHandler);\n  }\n\n  public async add(key: string, entry: any, fetchHandler?: () => (Promise<any> | void)) {\n    let obj = this.getRootFromPath(key);\n    obj = typeof obj === 'object' ? Object(obj) : {};\n\n    let pathArr = key.split('/');\n    let path = pathArr.slice(1).join('/');\n\n    obj = this.setDeepVal(obj, path, entry);\n    localStorage.setItem(`${this.name}_${pathArr[0]}`, JSON.stringify(obj));\n\n    return true;\n  }\n\n  private setDeepVal(obj, path: string, val) {\n    if (!path) {\n      if (typeof val === 'object') {\n        return { ...obj, ...val };\n      }\n\n      return obj;\n    }\n\n    let props = path.split('/');\n    let workingObj = obj;\n    for (var i = 0, n = props.length - 1; i < n; ++i) {\n      workingObj = workingObj[props[i]] = workingObj[props[i]] || {};\n    }\n    workingObj[props[i]] = val;\n\n    return obj;\n  }\n\n  private getRootFromPath(path: string) {\n    let rootPath = path.split('/')[0];\n\n    if (rootPath) {\n      let stringObj = localStorage.getItem(`${this.name}_${rootPath}`);\n\n      if (stringObj) {\n        return JSON.parse(stringObj);\n      }\n    }\n  }\n}\n","export * from './LocalStorageDriver';\nexport * from './NoDriver';\n\nexport function fromPath(obj, path: string, sep: string = '.') {\n  return path.split(sep).reduce((o, i) => (o === Object(o) ? o[i] : o), obj);\n}\n","import { NoDriver } from './drivers/NoDriver';\nimport Entry from './entry';\n\nexport * from './drivers';\n\nconst LOG_PREFIX = '[WebORM] ';\n\nexport default class WebORM {\n  public driver: WebORMDriver;\n  private APIMap: IAPIMap;\n\n  constructor(\n    public name: string,\n    options: IWebORMOptions = {}\n  ) {\n    this.APIMap = options.APIMap || {};\n    this.driver = new NoDriver();\n\n    if (options.drivers) {\n      options.drivers.forEach(driver => {\n        if ((this.driver instanceof NoDriver) && driver.isSuitable()) {\n          this.driver = driver;\n        }\n      });\n    }\n\n    if (this.driver instanceof NoDriver) {\n      console.warn(`${LOG_PREFIX} Warning! You have no suitable driver for database. Using memory instead.`);\n    }\n\n    this.driver.setName(name);\n    this.initPressetData(options.preset);\n  }\n\n  private initPressetData(data: any = {}) {\n    Object.keys(data).forEach(async presetKey => {\n      await this.driver.add(presetKey, data[presetKey]);\n    });\n  }\n\n  public async getEntry(key: string) {\n    let mapForPath = this.APIMap[key];\n    if (mapForPath && mapForPath.get) {\n      return this.driver.get(key, mapForPath.get);\n    }\n\n    return this.driver.get(key);\n  }\n\n  public async addEntry(key: string, entry: any) {\n    return this.driver.add(key, entry);\n  }\n}\n\nexport interface IWebORMOptions {\n  drivers?: WebORMDriver[];\n  preset?: { [key: string]: any };\n  APIMap?: IAPIMap;\n}\n\nexport interface IAPIMap {\n  [key: string]: {\n    get?: () => Promise<any>;\n    add?: () => (Promise<any> | void);\n  };\n}\n\nexport abstract class WebORMDriver {\n\n  /**\n   * Checks if driver can operate in current environment\n   *\n   * @returns is driver suitable\n   */\n  public isSuitable(): boolean { return false; }\n\n  public setName(name: string) { }\n\n  public async get(key: string, fetchHandler?: () => (Promise<any> | void)): Promise<Entry> {\n    return new Entry(this, key, null, fetchHandler);\n  }\n\n  public async add(key: string, entry: any, fetchHandler?: () => (Promise<any> | void)): Promise<boolean> {\n    return false;\n  }\n}\n"],"names":["LocalStorageDriver"],"mappings":"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"}